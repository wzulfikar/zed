name: OpenCode Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install opencode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Review PR
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENCODE_MODEL: "zai-coding-plan/glm-4.6"
          OPENCODE_PERMISSION: '{ "bash": { "/home/runner/post_pr_comment *": "allow", "*": "deny" } }'
        run: |
          # Configure OpenCode auth and model
          mkdir -p $HOME/.local/share/opencode/
          echo '{"zai-coding-plan": { "type": "api", "key": "'$ZAI_API_KEY'"}}' > $HOME/.local/share/opencode/auth.json

          # Create post_pr_comment script in the same step where it's used
          cat << 'EOF' > $HOME/post_pr_comment
          #!/bin/bash
          gh api \
            --method POST \
            -H 'Accept: application/vnd.github+json' \
            -H 'X-GitHub-Api-Version: 2022-11-28' \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
            -f 'commit_id=${{ github.event.pull_request.head.sha }}' \
            -f 'side=RIGHT' \
            $@
          EOF
          chmod +x $HOME/post_pr_comment

          opencode run -m $OPENCODE_MODEL "run $HOME/post_pr_comment hello"
