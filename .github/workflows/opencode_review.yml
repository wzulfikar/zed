name: OpenCode Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install opencode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Review PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENCODE_MODEL: "zai-coding-plan/glm-4.6"
          OPENCODE_PERMISSION: '{ "bash": { "./post_pr_comment*": "allow", "gh*": "allow", "gh api*": "deny", "gh pr review*": "deny", "*": "deny" } }'
        run: |
          # Create post_pr_comment script
          cat << 'EOF' > $PWD/post_pr_comment
          #!/bin/bash
          # Use temporary file to store the comment so we can use full markdown format
          printf '%s' "$1" > /tmp/comment.md
          # Strip full path to make it relative to current working directory
          diff_path=$(realpath --relative-to=. "$2")

          gh api --method POST \
            -H 'X-GitHub-Api-Version: 2022-11-28' \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
            --raw-field 'commit_id=${{ github.event.pull_request.head.sha }}' \
            --raw-field 'side=RIGHT' \
            --field "body=@/tmp/comment.md" --raw-field "path=$diff_path" --field "line=$3"
          EOF
          chmod +x $PWD/post_pr_comment

          # Configure OpenCode auth
          mkdir -p $HOME/.local/share/opencode/
          echo '{"zai-coding-plan": { "type": "api", "key": "'$ZAI_API_KEY'"}}' > $HOME/.local/share/opencode/auth.json

          # Start OpenCode with PR review prompt
          opencode run -m $OPENCODE_MODEL 'A new pull request has been created: "${{ github.event.pull_request.title }}"

          <repository>
          ${{ github.repository }}
          </repository>

          <pr-number>
          ${{ github.event.pull_request.number }}
          </pr-number>

          <pr-description>
          ${{ github.event.pull_request.body }}
          </pr-description>

          You are a diligent senior engineer. Review the code changes in this pull request against the guidelines in the ".rules" file. Only review the changes found in diffs, but feel free to read the entire file to get more context. Make it clear the suggestions are merely suggestions and the human can decide what to do. Be concise and to the point. Start directly with the comment, no need to state e.g. "The guideline states...". Wrap codes in backticks (`) or triple backticks (```) for inline and multi-line code respectively.

          How to post the comments:

          - Use the `post_pr_comment` command to create comments on the files for the violations.
          - Focus on changes in the diffs so you can leave the comment on the exact line number.
          - If you have a suggested fix, wrap the suggestion in codeblock.
          - Only create comments for actual violations. Don't run any `post_pr_comment` if no violations.
          - Command format MUST be like this:
            ./post_pr_comment '[comment]' '[path-to-file]' [line]
          "
