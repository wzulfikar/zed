name: OpenCode Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install opencode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Review PR
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENCODE_MODEL: "zai-coding-plan/glm-4.6"
          OPENCODE_PERMISSION: '{ "bash": { "./post_pr_comment*": "allow", "gh*": "allow", "gh api*": "deny", "gh pr review*": "deny", "*": "deny" } }'
        run: |
          # Create post_pr_comment script in the same step where it's used
          cat << 'EOF' > $PWD/post_pr_comment
          #!/bin/bash
          gh api --method POST \
            -H 'X-GitHub-Api-Version: 2022-11-28' \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
            -f 'commit_id=${{ github.event.pull_request.head.sha }}' \
            -f 'side=RIGHT' \
            -f "path=$1" -F "line=$2" -f 'body='$3''
          EOF
          chmod +x $PWD/post_pr_comment

          # Configure OpenCode auth and model
          mkdir -p $HOME/.local/share/opencode/
          echo '{"zai-coding-plan": { "type": "api", "key": "'$ZAI_API_KEY'"}}' > $HOME/.local/share/opencode/auth.json

          opencode run -m $OPENCODE_MODEL "A new pull request has been created: '${{ github.event.pull_request.title }}'

          <repository>
          ${{ github.repository }}
          </repository>

          <pr-number>
          ${{ github.event.pull_request.number }}
          </pr-number>

          <pr-description>
          ${{ github.event.pull_request.body }}
          </pr-description>

          Please check all the code changes in this pull request against the guidelines in '.rules' file in this repository. Diffs are important but make sure you read the entire file to get proper context. Make it clear the suggestions are merely suggestions and the human can decide what to do.

          Rules:
          - Use the 'post_pr_comment' command to create comments on the files for the violations.
          - Leave the comment on the exact line number.
          - If you have a suggested fix, include it in a suggestion code block.
          - Only create comments for actual violations. If the code follows all guidelines, don't run any 'post_pr_comment'.
          - Command format MUST be like this:

            <command>
            ./post_pr_comment '[path-to-file]' '[line]' '[summary of issue]'
            </command>
          "
